# TODO: Add 80, 443 VHOSTS

<VirtualHost *:<%= @params[:server_port] %>>
    ServerName <%= @params[:server_name] %>
    ServerAdmin <%= node[:apache][:contact] %>

    <% if @params[:server_aliases] -%>
          ServerAlias <%= @params[:server_aliases].join " " %>
    <% end -%>

    DocumentRoot <%= @params[:docroot] %>

    <Directory <%= @params[:docroot] %>>
        Options <%= [@params[:directory_options] || "FollowSymLinks" ].flatten.join " " %>
        AllowOverride <%= [@params[:allow_override] || "None" ].flatten.join " " %>
        Require all granted
    </Directory>

    <Directory />
        Options FollowSymLinks
        AllowOverride None
    </Directory>

    <Location /server-status>
        SetHandler server-status
        Require local
    </Location>

    <% if node['get-native']['environment'] != 'development' %>
    RewriteEngine On
    LogLevel info rewrite:trace1
    <% end -%>

    ErrorLog <%= node['apache']['log_dir'] %>/<%= @params[:name] %>-error.log
    CustomLog <%= node['apache']['log_dir'] %>/<%= @params[:name] %>-access.log combined

    <% if @params[:directory_index] -%>
    DirectoryIndex <%= [@params[:directory_index]].flatten.join " " %>
    <% end -%>

    <IfModule mod_deflate.c>
        SetOutputFilter DEFLATE
    </IfModule>

    <% if node['get-native']['environment'] != 'development' -%>
    RewriteCond %{HTTP_HOST}   !^<%= @params[:server_name] %> [NC]
    RewriteCond %{HTTP_HOST}   !^$
    RewriteRule ^/(.*)$        http://<%= @params[:server_name] %>/$1 [L,R=301]

    RewriteCond %{DOCUMENT_ROOT}/system/maintenance.html -f
    RewriteCond %{SCRIPT_FILENAME} !maintenance.html
    RewriteRule ^.*$ /system/maintenance.html [L,R=503]
    <% end -%>
</VirtualHost>

<% if node['get-native']['environment'] != 'development' -%>
<VirtualHost *:<%= @params[:server_port] %>>
    ServerName www.<%= @params[:server_name] %>
    Redirect 301 / http://<%= @params[:server_name] %>
</VirtualHost>

<VirtualHost *:443>
  <IfModule mod_ssl.c>
      SSLEngine On
      SSLCertificateFile <%= "#{node['apache']['dir']}/ssl/#{node['get-native']['domain']}" %>.crt
      SSLCertificateKeyFile <%= "#{node['apache']['dir']}/ssl/#{node['get-native']['domain']}" %>.key
      SSLCertificateChainFile <%= "#{node['apache']['dir']}/ssl/#{node['get-native']['domain']}" %>.pem
  </IfModule>
  ServerAdmin <%= node[:apache][:contact] %>
  ServerName <%= @params[:server_name] %>
  UseCanonicalName Off

  <% if @params[:server_aliases] -%>
  ServerAlias <%= @params[:server_aliases].join " " %>
  <% end -%>
</VirtualHost>
<% end -%>
