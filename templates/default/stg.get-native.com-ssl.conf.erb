<VirtualHost *:80>
    ServerName <%= @params[:server_name] %>
    ServerAdmin <%= node[:apache][:contact] %>
    RedirectPermanent / https://<%= node['get-native']['server_name'] %>
</VirtualHost>

<VirtualHost *:80>
    ServerName www.<%= @params[:server_name] %>
    ServerAdmin <%= node[:apache][:contact] %>
    RedirectPermanent / https://<%= node['get-native']['server_name'] %>
</VirtualHost>

<VirtualHost *:443>
    ServerName www.<%= @params[:server_name] %>
    ServerAdmin <%= node[:apache][:contact] %>
    RedirectPermanent / https://<%= node['get-native']['server_name'] %>
    SSLCertificateFile <%= node['apache']['dir'] %>/ssl/live/<%= @params[:server_name] %>/fullchain.pem
    SSLCertificateKeyFile <%= node['apache']['dir'] %>/ssl/live/<%= @params[:server_name] %>/privkey.pem
    Include <%= node['apache']['dir'] %>/ssl/options-ssl-apache.conf
</VirtualHost>

<VirtualHost *:443>
    ServerName <%= @params[:server_name] %>
    ServerAdmin <%= node[:apache][:contact] %>
    DocumentRoot <%= @params[:docroot] %>

    <% if @params[:server_aliases] -%>
    ServerAlias <%= @params[:server_aliases].join ' ' %>
    <% end -%>

    RewriteEngine On

    <Directory <%= @params[:docroot] %>>
        Options <%= [@params[:directory_options] || 'FollowSymLinks'].flatten.join ' ' %>
        AllowOverride <%= [@params[:allow_override] || 'None'].flatten.join ' ' %>
        Require all denied
        Require ip <%= node['get-native']['ip-whitelist'].flatten.join ' ' %>

        RewriteEngine On
        RewriteBase /
        RewriteRule ^index\.html$ - [L]
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule . /index.html [L]
    </Directory>

    <Directory />
        Options FollowSymLinks
        AllowOverride None
    </Directory>

    LogLevel info rewrite:trace1
    ErrorLog <%= node['apache']['log_dir'] %>/<%= @params[:name] %>-error.log
    CustomLog <%= node['apache']['log_dir'] %>/<%= @params[:name] %>-access.log combined

    <% if @params[:directory_index] -%>
    DirectoryIndex <%= [@params[:directory_index]].flatten.join ' ' %>
    <% end -%>

    <IfModule deflate_module>
        SetOutputFilter DEFLATE
    </IfModule>

    <IfModule http2_module>
        Protocols h2 http/1.1
    </IfModule>

    UseCanonicalName Off

    RewriteCond %{HTTP_HOST}   !^<%= @params[:server_name] %> [NC]
    RewriteCond %{HTTP_HOST}   !^$
    RewriteRule ^/(.*)$        http://<%= @params[:server_name] %>/$1 [L,R=301]

    SSLCertificateFile <%= node['apache']['dir'] %>/ssl/live/<%= @params[:server_name] %>/fullchain.pem
    SSLCertificateKeyFile <%= node['apache']['dir'] %>/ssl/live/<%= @params[:server_name] %>/privkey.pem
    Include <%= node['apache']['dir'] %>/ssl/options-ssl-apache.conf

    AddCharset utf-8 .js

    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    Header always set Content-Security-Policy upgrade-insecure-requests
    Header always set X-XSS-Protection "1; mode=block"
    Header always set X-Content-Type-Options nosniff

    <FilesMatch ".+\.html$">
        Header always set X-Frame-Options deny
    </FilesMatch>
</VirtualHost>
