<VirtualHost *:80>
    ServerName <%= @params[:server_name] %>
    ServerAlias www.<%= @params[:server_name] %>
    ServerAdmin <%= node[:apache][:contact] %>

    RewriteEngine on
    RewriteCond %{SERVER_NAME} =www.<%= @params[:server_name] %> [OR]
    RewriteCond %{SERVER_NAME} =<%= @params[:server_name] %>
    RewriteRule ^ https://%{SERVER_NAME}%{REQUEST_URI} [END,QSA,R=permanent]
</VirtualHost>

<VirtualHost *:443>
    ServerName <%= @params[:server_name] %>
    ServerAlias www.<%= @params[:server_name] %>
    ServerAdmin <%= node[:apache][:contact] %>

    ProxyRequests Off
    SSLProxyEngine On

    <Location />
        ProxyPass "http://localhost:3000/"
        ProxyPassReverse "http://localhost:3000/"
    </Location>

    ProxyPreserveHost On

    <Proxy *>
    Require all denied
    Require ip <%= node['get-native']['ip-whitelist'].flatten.join ' ' %>
    </Proxy>

    ErrorLog <%= node['apache']['log_dir'] %>/<%= @params[:server_name] %>-error.log
    CustomLog <%= node['apache']['log_dir'] %>/<%= @params[:server_name] %>-access.log combined

    <IfModule deflate_module>
        SetOutputFilter DEFLATE
    </IfModule>

    SSLCertificateFile <%= node['apache']['dir'] %>/ssl/live/<%= @params[:server_name] %>/fullchain.pem
    SSLCertificateKeyFile <%= node['apache']['dir'] %>/ssl/live/<%= @params[:server_name] %>/privkey.pem

    Include <%= node['apache']['dir'] %>/ssl/options-ssl-apache.conf

    <IfModule expires_module>
        ExpiresActive  on
        ExpiresDefault "access plus 0 seconds"
    </IfModule>

    <IfModule headers_module>
        Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        Header always set Content-Security-Policy upgrade-insecure-requests
        Header always set X-XSS-Protection "1; mode=block"
        Header always set X-Content-Type-Options nosniff
        Header always set Cache-Control "no-cache"
        Header always set Pragma "no-cache"
    </IfModule>
</VirtualHost>
